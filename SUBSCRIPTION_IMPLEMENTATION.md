# Реализация поддержки подписок 3X-UI

## Дата: 12 декабря 2024

### Что было реализовано

Полная поддержка загрузки и управления VLESS подписками от 3X-UI с функцией переключения между профилями.

## Созданные файлы

### 1. **lib/models/vpn_subscription.dart** - Модель подписки
- Класс `VpnSubscription` с полями:
  - `id` - уникальный идентификатор (UUID)
  - `name` - имя подписки
  - `url` - URL подписки (base64-кодированное содержимое)
  - `profiles` - список VLESS URI
  - `selectedIndex` - индекс выбранного профиля (0-based)
  - `lastUpdated` - время последнего обновления
  - `error` - сообщение об ошибке (если есть)

- Методы:
  - `selectedProfile` - возвращает выбранный VLESS URI
  - `formattedLastUpdate` - форматированная дата на русском
  - `profileCount` - количество профилей
  - `toJson() / fromJson()` - сериализация/десериализация
  - `copyWith()` - создание копии с изменениями

### 2. **lib/services/subscription_manager.dart** - Сервис загрузки подписок
- Класс `SubscriptionService` с методами:
  - `fetchSubscription(url)` - загружает подписку по URL
    - HTTP GET запрос с заголовками User-Agent
    - Декодирование base64
    - Извлечение VLESS URI
    - Таймаут 30 секунд (настраивается)
  
  - `getSubscriptionInfo(url)` - получить информацию о подписке
    - Количество профилей
    - Время получения
    - Список профилей
  
  - `isValidSubscriptionUrl(url)` - валидация URL
    - Проверка абсолютности URI
    - Проверка схемы

- Вспомогательные методы:
  - `_decodeBase64(encoded)` - декодирование base64 с обработкой ошибок
  - `_parseProfiles(content)` - извлечение VLESS URI из текста

- Обработка ошибок:
  - SocketException → ошибка сети
  - TimeoutException → истёк таймаут
  - Другие исключения → детальное сообщение об ошибке

### 3. **lib/services/subscription_repository.dart** - Репозиторий подписок
- Класс `SubscriptionRepository` для работы с SharedPreferences
- Методы:
  - `getAllSubscriptions()` - получить все подписки
  - `getSubscription(id)` - получить подписку по ID
  - `addSubscription(sub)` - добавить новую подписку
  - `updateSubscription(sub)` - обновить существующую подписку
  - `deleteSubscription(id)` - удалить подписку
  - `getSelectedSubscription()` - получить текущую выбранную подписку
  - `setSelectedSubscription(id)` - установить выбранную подписку
  - `clearSelectedSubscription()` - очистить выбор

- Хранилище: SharedPreferences ключ `vpn_subscriptions_list`
- JSON сериализация для сохранения

### 4. **lib/widgets/subscription_manager.dart** - UI компонент
- Главный виджет `SubscriptionManager` (StatefulWidget)
  - Список всех подписок
  - Возможность добавить подписку
  - Для каждой подписки:
    - Отображение имени, URL, количества профилей
    - Дата последнего обновления
    - Список радио-кнопок для выбора профиля
    - Кнопки "Обновить" и "Удалить"

- Вспомогательный диалог `_AddSubscriptionDialog`
  - Ввод имени подписки
  - Ввод URL подписки
  - Валидация перед добавлением

- Функционал:
  - Загрузка подписок при открытии
  - Добавление новой подписки с проверкой валидности
  - Обновление подписки (перезагрузка профилей)
  - Удаление подписки с подтверждением
  - Выбор профиля из подписки
  - Сообщения об ошибках через SnackBar

## Изменённые файлы

### **lib/main.dart**
- Добавлен импорт виджета подписок
- Увеличено количество вкладок с 3 на 4
- Добавлена вкладка "Подписки" с UI компонентом
- TabBar и TabBarView обновлены для поддержки новой вкладки

### **pubspec.yaml**
- Добавлена зависимость `http: ^1.1.0` для HTTP запросов
- Добавлена зависимость `intl: ^0.19.0` для форматирования даты на русском

## Как это работает

### Процесс добавления подписки:
1. Пользователь нажимает "+" на вкладке Подписки
2. Вводит имя подписки и URL
3. Приложение загружает содержимое с URL
4. Декодирует base64
5. Извлекает все VLESS URI
6. Сохраняет в SharedPreferences
7. Отображает список профилей

### Процесс выбора профиля:
1. Пользователь нажимает радио-кнопку рядом с профилем
2. Обновляется `selectedIndex` в подписке
3. Автоматически сохраняется в SharedPreferences
4. При переходе на вкладку "Подключение" можно использовать выбранный профиль

### Процесс обновления подписки:
1. Пользователь нажимает "Обновить"
2. Приложение повторно загружает содержимое с URL
3. Парсит VLESS URI заново
4. Обновляет список профилей
5. Обновляет время `lastUpdated`
6. Сохраняет изменения

## Обработка ошибок

- **Неверный URL** - невозможно распарсить как URI
- **Ошибка HTTP** - код ответа != 200
- **Ошибка сети** - SocketException
- **Таймаут** - истёк 30-секундный лимит
- **Ошибка base64** - содержимое не является валидным base64
- **Нет VLESS** - не найдено ни одной строки с `vless://`

Все ошибки отображаются в UI и сохраняются в поле `error` подписки.

## Интеграция с существующим кодом

- Подписки хранятся отдельно от обычных профилей
- Выбранный профиль из подписки можно использовать в tab "Подключение"
- Все компоненты используют вот `BLoC` или `GetIt` не требуют - просто State

## Тестирование

Для тестирования на localhost:
1. Создать простой HTTP сервер, который возвращает base64-кодированный текст с VLESS URI
2. Добавить подписку с URL `http://localhost:8080/subscribe`
3. Проверить загрузку и парсинг профилей

Пример base64 (раскодировано):
```
vless://a684955c-b022-4530-825f-7eae4adc1eca@example.com:443?...
vless://b123abc1-c022-4530-825f-7eae4adc1eca@example2.com:443?...
```

## TODO для будущих улучшений

1. Добавить кэширование подписок (не переоскрывать при каждом обновлении)
2. Добавить автоматическое обновление подписок по расписанию
3. Добавить группировку профилей по серверам
4. Добавить сортировку профилей (по скорости, пингу и т.д.)
5. Добавить синхронизацию выбранного профиля с вкладкой "Подключение"
6. Добавить экспорт/импорт подписок
7. Добавить поддержку нескольких формат подписок (sing-box и т.д.)
