# Функционал подписок 3X-UI

## Обзор

Приложение теперь поддерживает загрузку VLESS конфигураций из подписок 3X-UI. Это позволяет:

1. **Добавлять подписки** - загружать все конфигурации сразу по одному URL
2. **Переключаться между профилями** - выбирать нужный VLESS URI из списка профилей в подписке
3. **Обновлять подписки** - получать свежие конфигурации нажатием одной кнопки
4. **Управлять подписками** - добавлять, удалять, переименовывать подписки

## Как использовать

### 1. Добавление подписки

- Откройте вкладку **"Подписки"** в приложении
- Нажмите кнопку **"+"** (добавить)
- В диалоге введите:
  - **Имя подписки** - произвольное имя для идентификации (например, "Мой сервер")
  - **URL подписки** - полный URL с токеном доступа (например, `https://3x-ui.example.com/api/inbound/getClient/...`)
- Нажмите **"Добавить"**

### 2. Переключение профилей

После добавления подписки вы увидите карточку с информацией:
- Имя подписки
- Количество профилей в подписке
- Список всех VLESS URI в подписке
- Переключатели (радио-кнопки) для выбора профиля
- Кнопки "Обновить" и "Удалить"

Нажмите на радио-кнопку рядом с нужным профилем, чтобы выбрать его.

### 3. Обновление подписки

Нажмите кнопку **"Обновить"** на карточке подписки для загрузки свежих конфигураций.

При обновлении:
- Загружаются новые профили с сервера
- Обновляется время последнего обновления
- Если профилей было удалено, они удаляются из списка
- Если новые профили добавлены, они появляются в списке

### 4. Удаление подписки

Нажмите кнопку **"Удалить"** на карточке подписки и подтвердите удаление.

## Технические детали

### Структура данных

Каждая подписка содержит:
```dart
class VpnSubscription {
  String id;                    // Уникальный ID подписки
  String name;                  // Имя подписки
  String url;                   // URL подписки
  List<String> profiles;        // Список VLESS URI
  int selectedIndex;            // Индекс выбранного профиля
  DateTime lastUpdated;         // Время последнего обновления
  String? error;                // Сообщение об ошибке (если есть)
}
```

### Сохранение

- Все подписки сохраняются в **SharedPreferences** под ключом `vpn_subscriptions_list`
- Каждая подписка сохраняется в формате JSON
- Автоматически восстанавливаются при запуске приложения

### Парсинг подписок

Подписка должна быть в формате **base64**, содержащем VLESS URI:

```
vless://your-uuid@server.com:443?...
vless://another-uuid@server2.com:443?...
...
```

При загрузке подписки:
1. Содержимое декодируется из base64
2. Извлекаются все строки, начинающиеся с `vless://`
3. Остальное содержимое игнорируется (комментарии, пустые строки)

## Исходные файлы

- **lib/models/vpn_subscription.dart** - модель данных подписки
- **lib/services/subscription_manager.dart** - сервис для загрузки и парсинга
- **lib/services/subscription_repository.dart** - репозиторий для сохранения подписок
- **lib/widgets/subscription_manager.dart** - UI компонент управления подписками

## Обработка ошибок

При ошибке загрузки подписки:
- Приложение показывает понятное сообщение об ошибке
- Старые конфигурации остаются в памяти
- Можно попробовать обновить подписку снова позже

Возможные ошибки:
- **Неверный URL** - проверьте корректность URL
- **Ошибка HTTP** - проверьте доступность сервера
- **Таймаут** - увеличьте время ожидания или проверьте соединение
- **Ошибка декодирования** - убедитесь, что содержимое в формате base64
- **Нет VLESS профилей** - подписка не содержит ни одного валидного VLESS URI
